# B树

B树是一种自平衡树数据结构，用于维护排序的数据，并允许以对数时间进行搜索，顺序访问，插入和删除。 B树概括了二叉搜索树，允许具有两个子节点以上（包含1个以上的key）的节点。
B-tree非常适合于读写较大数据块（如磁盘）的存储系统。它通常用于数据库和文件系统。

![btree image](https://codetube.vn/images/btree.png "B树")

<!-- HeadMark -->

- [Definitions](#definitions)
- [Implementation](#implementation)
  - [Search](#search)
  - [Insertion](#insertion)
  - [Deletion](#deletion)
- [References](#references)
- [Demostration](#demostration)

## Definitions

根据此实现，度为d（m阶 = 2 * d）的B树是满足以下属性的树：

- 每个节点最多具有2 * d-1个key（非叶节点为2 * d个）。
- 除根节点外，每个节点至少具有d-1个key（非叶节点为d个子节点）。
- 一个有k个子节点的非叶子节点包含k − 1个key。
- 所有叶子都出现在同一层。

每个内部节点的key用作分隔其子树的分隔值。例如，如果内部节点具有3个子节点（或子树），则它必须具有2个key：a1和a2。最左侧子树中的所有值都将小于a1，中间子树中的所有值都将在a1和a2之间，而最右侧子树中的所有值都将大于a2。

## Implementation

### Search

搜索类似于搜索二进制搜索树。从根节点开始，从上到下递归遍历树。在每个层级，搜索都会将其范围缩小为包括搜索值的子指针（子树）。子树的范围由其父节点中包含的值或key定义。这些极限值也称为间隔值。

通常（但不一定）在节点内使用二进制搜索来查找分离值和感兴趣的子树。

### Insertion

要插入新元素，请搜索树以找到应在其中添加新元素的叶子节点。通过以下步骤将新元素插入该节点：

- 在从根节点到要进行插入的节点中搜索树时，将在途中遇到的所有完整节点首先分成两组节点：
  - 从节点的key和新key中选择一个中位数。
  - 小于中位数的key将放置在新的左节点中，大于中位数的key将放置在新的右节点中，其中位数用作分隔key。
  - 分隔值插入到节点的父节点中（这保证了节点不是完整的）。如果该节点没有父节点（即该节点是根节点），则在该节点上方创建一个新的根节点（增加树的高度）。
- 到达非完整叶子节点，只需在正确位置插入新key即可。

### Deletion

要删除元素/key，请按照以下策略搜索树以找到应删除元素的节点：

- 从根节点到要删除的节点搜索树时，在进入节点之前，如果该节点具有min（d-1）个元素，我们将执行重组，以确保我们经过的每个节点都具有min以上个元素（以便我们可以在下一步中轻松删除一个元素）：
  - 如果左侧同级的元素数大于min，则将一个元素从左侧同级移动到当前节点（向右旋转）。
  - 如果不是，请检查右同级元素是否大于min，然后将一个元素从右同级元素移动到当前节点（向左旋转）。
  - 如果以上都不是（如果同时存在，则表示左侧和右侧同级都具有min（d-1）个元素），请将当前节点与右侧同级合并（如果右侧不存在，则合并左侧同级）。要执行合并，我们必须从父级中删除两个子级的分离元素（因为父节点中有多个min元素，这样就可以了），然后以以下形式将其放到合并节点的中间：`...left-elements, separation-element, ...right-elements`。合并的节点将具有（d-1）+ 1 +（d-1）= 2 * d-1，这是最大元素数。
  - 旋转或合并元素后，对于非叶节点，我们将必须相应地调整子节点（节点指针数组）。
- 如果在叶节点上找到delete元素，则只需从叶中删除该元素。
- 如果在非叶子节点上找到delete元素：
  - 在找到的元素左侧的子树中删除max元素。这等效于删除最右边的叶子中的最右边的元素，因此在上面的`叶子节点处可以找到删除元素`。
  - 向上移动该最大元素以替换在节点中找到的元素。

## References

[WIKI](https://zh.wikipedia.org/wiki/B%E6%A0%91)

## Demostration

<!-- EndMark -->

[B-tree](https://codetube.vn/btree)
